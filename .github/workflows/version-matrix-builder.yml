# .github/workflows/version-matrix-builder.yml
# Automated Windows Release Detection & Build Trigger System
# Author: kelexine (https://github.com/kelexine)

name: Version Matrix Builder

on:
  schedule:
    # Run daily at 00:00 UTC to check for new releases
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force check even if no new version detected'
        required: false
        type: boolean
        default: false
      skip_build:
        description: 'Skip build trigger (detection only)'
        required: false
        type: boolean
        default: false

env:
  # Windows release monitoring endpoints
  UUPDUMP_API: 'https://api.uupdump.net'
  RELEASE_TRACKING_FILE: 'tracked_releases.json'
  
jobs:
  detect-releases:
    name: Detect New Windows Releases
    runs-on: ubuntu-latest
    outputs:
      new_releases: ${{ steps.check.outputs.new_releases }}
      releases_matrix: ${{ steps.check.outputs.releases_matrix }}
      has_new: ${{ steps.check.outputs.has_new }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'
      
      - name: Install Dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            # Fallback to direct install if no requirements file
            pip install requests beautifulsoup4 lxml
          fi
      
      - name: Fetch Current Tracked Releases
        id: fetch_tracked
        run: |
          if [ -f "${{ env.RELEASE_TRACKING_FILE }}" ]; then
            echo "tracked_data=$(cat ${{ env.RELEASE_TRACKING_FILE }})" >> $GITHUB_OUTPUT
          else
            echo "tracked_data={}" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for New Releases
        id: check
        env:
          FORCE_CHECK: ${{ github.event.inputs.force_check || 'false' }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          from datetime import datetime
          
          # Configuration
          UUPDUMP_API = os.environ['UUPDUMP_API']
          FORCE_CHECK = os.environ.get('FORCE_CHECK', 'false').lower() == 'true'
          
          # Windows editions to monitor
          EDITIONS = ['Professional', 'Home', 'Education', 'Pro N']
          CHANNELS = ['retail', 'insider']
          
          print("ðŸ” Checking for new Windows 11 releases...")
          
          try:
              # Fetch latest builds from UUP Dump API
              response = requests.get(f"{UUPDUMP_API}/listid.php", params={
                  'search': 'Windows 11',
                  'sortByDate': '1'
              })
              response.raise_for_status()
              builds = response.json()
              
              # Load previously tracked releases
              tracked_file = os.environ.get('RELEASE_TRACKING_FILE', 'tracked_releases.json')
              try:
                  with open(tracked_file, 'r') as f:
                      tracked = json.load(f)
              except FileNotFoundError:
                  tracked = {'builds': {}, 'last_check': None}
              
              new_releases = []
              releases_matrix = []
              
              # Process builds
              for build in builds.get('response', {}).get('builds', [])[:20]:  # Check top 20
                  build_id = build.get('uuid')
                  build_num = build.get('build')
                  title = build.get('title', '')
                  arch = build.get('arch', 'amd64')
                  
                  # Filter for x64 Windows 11 only
                  if 'Windows 11' not in title or arch != 'amd64':
                      continue
                  
                  # Extract version info
                  version = 'Unknown'
                  if '24H2' in title:
                      version = '24H2'
                  elif '25H2' in title:
                      version = '25H2'
                  elif '23H2' in title:
                      version = '23H2'
                  
                  # Check if this is a new build
                  if build_id not in tracked.get('builds', {}) or FORCE_CHECK:
                      print(f"âœ¨ New release detected: {title} (Build {build_num})")
                      
                      # Attempt to get download URL
                      try:
                          detail_resp = requests.get(f"{UUPDUMP_API}/get.php", params={
                              'id': build_id,
                              'pack': 'en-us',
                              'edition': 'professional'
                          })
                          detail_data = detail_resp.json()
                          
                          # Generate ISO URL (UUP Dump format)
                          iso_url = f"https://uupdump.net/download.php?id={build_id}&pack=en-us&edition=professional"
                          
                          release_info = {
                              'build_id': build_id,
                              'build_number': build_num,
                              'version': version,
                              'title': title,
                              'iso_url': iso_url,
                              'detected_date': datetime.now().isoformat(),
                              'architecture': arch
                          }
                          
                          new_releases.append(release_info)
                          releases_matrix.append({
                              'version': version,
                              'build': build_num,
                              'iso_url': iso_url,
                              'title': title.replace(' ', '_').replace('(', '').replace(')', '')
                          })
                          
                          # Mark as tracked
                          tracked['builds'][build_id] = release_info
                          
                      except Exception as e:
                          print(f"âš ï¸  Error fetching details for {build_id}: {e}")
                          continue
              
              # Update tracking file
              tracked['last_check'] = datetime.now().isoformat()
              with open(tracked_file, 'w') as f:
                  json.dump(tracked, f, indent=2)
              
              # Set outputs
              has_new = 'true' if new_releases else 'false'
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"new_releases={json.dumps(new_releases)}\n")
                  f.write(f"releases_matrix={json.dumps(releases_matrix)}\n")
                  f.write(f"has_new={has_new}\n")
              
              if new_releases:
                  print(f"\nâœ… Found {len(new_releases)} new release(s)!")
                  for rel in new_releases:
                      print(f"  - {rel['title']} (Build {rel['build_number']})")
              else:
                  print("\nðŸ“­ No new releases detected.")
              
          except Exception as e:
              print(f"âŒ Error during release check: {e}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("has_new=false\n")
                  f.write("new_releases=[]\n")
                  f.write("releases_matrix=[]\n")
          EOF
      
      - name: Commit Updated Tracking File
        if: steps.check.outputs.has_new == 'true'
        run: |
          git config user.name "Version Matrix Bot"
          git config user.email "bot@kelexine.dev"
          git add ${{ env.RELEASE_TRACKING_FILE }}
          git commit -m "ðŸ¤– Update tracked releases - $(date -u +'%Y-%m-%d %H:%M UTC')" || echo "No changes to commit"
          git push origin main || echo "Push failed, continuing..."
      
      - name: Create GitHub Issue for New Release
        if: steps.check.outputs.has_new == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newReleases = JSON.parse('${{ steps.check.outputs.new_releases }}');
            
            for (const release of newReleases) {
              const issueBody = `
              ## ðŸŽ‰ New Windows Release Detected
              
              **Build Information:**
              - **Title:** ${release.title}
              - **Build Number:** ${release.build_number}
              - **Version:** ${release.version}
              - **Architecture:** ${release.architecture}
              - **Detection Date:** ${release.detected_date}
              
              **ISO Source:**
              - ${release.iso_url}
              
              **Automated Actions:**
              - [ ] Trigger Tiny11 Standard build
              - [ ] Trigger Tiny11 Core build
              - [ ] Trigger Nano11 build
              - [ ] Test builds in VM
              - [ ] Upload to SourceForge
              
              ---
              *This issue was automatically created by the Version Matrix Builder*
              `;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ†• New Windows ${release.version} Release - Build ${release.build_number}`,
                body: issueBody,
                labels: ['automated', 'new-release', 'build-pending']
              });
            }

  trigger-builds:
    name: Trigger Automated Builds
    needs: detect-releases
    if: needs.detect-releases.outputs.has_new == 'true' && github.event.inputs.skip_build != 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        release: ${{ fromJson(needs.detect-releases.outputs.releases_matrix) }}
        build_type: ['standard', 'core', 'nano']
        edition: [1, 6]  # Home and Pro
    
    steps:
      - name: Trigger Build Workflow
        uses: actions/github-script@v7
        with:
          script: |
            const workflowMap = {
              'standard': 'build-tiny11.yml',
              'core': 'build-tiny11-core.yml',
              'nano': 'build-nano11.yml'
            };
            
            const editionMap = {
              1: 'Home',
              6: 'Pro'
            };
            
            const workflow = workflowMap['${{ matrix.build_type }}'];
            const release = ${{ toJson(matrix.release) }};
            const edition = ${{ matrix.edition }};
            
            console.log(`ðŸš€ Triggering ${workflow} for ${release.version} (${editionMap[edition]})`);
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow,
              ref: 'main',
              inputs: {
                windows_iso_url: release.iso_url,
                image_index: edition.toString(),
                skip_cleanup: 'false',
                windows_version: release.version
              }
            });
            
            console.log(`âœ… Build triggered successfully!`);

  notify-completion:
    name: Send Notification
    needs: [detect-releases, trigger-builds]
    if: always() && needs.detect-releases.outputs.has_new == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Notification
        run: |
          echo "ðŸ“¢ Version Matrix Builder completed!"
          echo "New releases detected: ${{ needs.detect-releases.outputs.has_new }}"
          echo "Builds triggered: ${{ needs.trigger-builds.result }}"
          
          # Add Discord/Slack/Email notification here if needed
          # Example with webhook:
          # curl -X POST $WEBHOOK_URL -H 'Content-Type: application/json' \
          #   -d '{"content":"ðŸŽ‰ New Windows release detected and builds triggered!"}'